# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Spring CD (Production)

# main ë¸Œëžœì¹˜ PRì—ì„œë§Œ ì‹¤í–‰ (ì´ë¯¸ ë¹Œë“œëœ Docker ì´ë¯¸ì§€ ì‚¬ìš©)
on:
  pull_request:
    branches:
      - main

jobs:
  # ==================================
  # CD: Deploy to Production Environment
  # ==================================
  cd-production:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Docker Image Exists
        run: |
          IMAGE=ghcr.io/${{ github.repository }}/zoopzoop:latest
          echo "ðŸ” Checking if Docker image exists: $IMAGE"
          
          # ì´ë¯¸ì§€ê°€ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
          if docker pull $IMAGE; then
            echo "âœ… Docker image found and pulled successfully"
            docker images | grep zoopzoop
          else
            echo "âŒ Docker image not found. Please ensure CI has run on develop branch first."
            exit 1
          fi

      - name: Deploy to Production Environment
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            DB_URL="${{ secrets.PROD_DB_URL }}"
            DB_USERNAME="${{ secrets.PROD_DB_USERNAME }}"
            DB_PASSWORD="${{ secrets.PROD_DB_PASSWORD }}"

            echo "ðŸš€ Starting deployment to PRODUCTION environment"
            echo "âš ï¸  Using pre-built Docker image from develop branch"

            IMAGE=ghcr.io/${{ github.repository }}/zoopzoop:latest
            BLUE_PORT=8081
            GREEN_PORT=8082
            BLUE=zoopzoop-blue
            GREEN=zoopzoop-green

            # Blue-Green ë°°í¬ ë¡œì§
            if sudo grep -q "$BLUE_PORT" /etc/nginx/nginx.conf; then
              CURRENT=$BLUE
              CURRENT_PORT=$BLUE_PORT
              NEXT=$GREEN
              NEXT_PORT=$GREEN_PORT
            else
              CURRENT=$GREEN
              CURRENT_PORT=$GREEN_PORT
              NEXT=$BLUE
              NEXT_PORT=$BLUE_PORT
            fi

            echo "Current live: $CURRENT ($CURRENT_PORT)"
            echo "Next to deploy: $NEXT ($NEXT_PORT)"

            # ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            if [ "$(docker ps -q -f name=$NEXT)" ]; then
              docker stop $NEXT
            fi
            if [ "$(docker ps -aq -f name=$NEXT)" ]; then
              docker rm $NEXT
            fi

            # ìƒˆ ì´ë¯¸ì§€ pull ë° ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (developì—ì„œ ë¹Œë“œëœ ì´ë¯¸ì§€ ì‚¬ìš©)
            docker pull $IMAGE
            docker run -d --name $NEXT \
              -e SPRING_DATASOURCE_URL="$DB_URL" \
              -e SPRING_DATASOURCE_USERNAME="$DB_USERNAME" \
              -e SPRING_DATASOURCE_PASSWORD="$DB_PASSWORD" \
              -p $NEXT_PORT:8080 $IMAGE

            # Health check (í”„ë¡œë•ì…˜ì´ë¯€ë¡œ ë” ì—„ê²©í•˜ê²Œ)
            echo "ðŸ” Starting health check for PRODUCTION..."
            for i in {1..60}; do  # í”„ë¡œë•ì…˜ì€ ë” ì˜¤ëž˜ ê¸°ë‹¤ë¦¼
              if curl -s http://127.0.0.1:$NEXT_PORT/actuator/health | grep '"status":"UP"' > /dev/null; then
                echo "âœ… $NEXT is healthy!"
                break
              fi
              echo "â³ Waiting for $NEXT to be healthy... ($i/60)"
              sleep 3  # í”„ë¡œë•ì…˜ì€ ë” ì—¬ìœ ë¡­ê²Œ
              if [ $i -eq 60 ]; then
                echo "âŒ Health check failed. Rolling back..."
                docker stop $NEXT
                docker rm $NEXT
                exit 1
              fi
            done

            # ì¶”ê°€ ê²€ì¦ (í”„ë¡œë•ì…˜ìš©)
            echo "ðŸ” Running additional production checks..."
            
            # API ì‘ë‹µ í…ŒìŠ¤íŠ¸
            if curl -s http://127.0.0.1:$NEXT_PORT/actuator/info > /dev/null; then
              echo "âœ… Info endpoint responding"
            else
              echo "âš ï¸ Info endpoint not responding"
            fi

            # Nginx ì„¤ì • ë³€ê²½
            echo "ðŸ”„ Switching Nginx to new container..."
            sudo sed -i "s/$CURRENT_PORT/$NEXT_PORT/g" /etc/nginx/nginx.conf
            sudo nginx -s reload
            echo "âœ… Switched Nginx to $NEXT ($NEXT_PORT)"

            # ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (í”„ë¡œë•ì…˜ì—ì„œëŠ” ì¢€ ë” ê¸°ë‹¤ë¦¼)
            if [ "$(docker ps -q -f name=$CURRENT)" ]; then
              echo "â³ Waiting 30 seconds before stopping old container..."
              sleep 30
              echo "ðŸ§¹ Stopping previous container: $CURRENT"
              docker stop $CURRENT
              docker rm $CURRENT
            fi

            echo "ðŸŽ‰ PRODUCTION deployment completed successfully!"
            echo "ðŸŒ Production is now live!"

      - name: Production Deployment Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Successfully deployed to PRODUCTION" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ³ **Docker Image**: \`ghcr.io/${{ github.repository }}/zoopzoop:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Note**: Used pre-built image from develop branch" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        run: |
          echo "## âŒ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Check**: Ensure Docker image exists (run develop CI first)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Check**: Verify production server connectivity" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Check**: Database credentials and connectivity" >> $GITHUB_STEP_SUMMARY